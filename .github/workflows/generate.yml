name: Generate domain and IP list

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * 1"  # 每周一凌晨3点

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y unzip curl

      - name: Download Tranco top-1m list
        shell: bash
        run: |
          set -euo pipefail
          curl -L https://tranco-list.eu/top-1m.csv.zip -o top-1m.csv.zip
          unzip -o top-1m.csv.zip
          # 只保留域名列
          cut -d',' -f2 top-1m.csv > top-1m.domain

      - name: Download direct-list and normalize
        shell: bash
        run: |
          set -euo pipefail
          curl -L https://raw.githubusercontent.com/Loyalsoldier/v2ray-rules-dat/release/direct-list.txt -o direct-list.txt
          # 去除开头的full:
          sed -i 's/^full://' direct-list.txt
          # 去除regexp:开头的行
          sed -i '/^regexp:/d' direct-list.txt
          # 去除注释、空行与前后空白
          sed -i 's/^[[:space:]]\+//;s/[[:space:]]\+$//' direct-list.txt
          sed -i '/^$/d' direct-list.txt
          sed -i 's/#.*$//' direct-list.txt
          sed -i '/^$/d' direct-list.txt

      - name: Filter domains with suffix matching (optimized)
        shell: bash
        run: |
          set -euo pipefail
          cat > filter_domains.awk <<'AWK'
          BEGIN {
            suffix_count = 0
            while ((getline line < "direct-list.txt") > 0) {
              if (line != "") {
                suffixes[line] = 1
                suffix_count++
              }
            }
            close("direct-list.txt")
            printf "Loaded %d suffixes, filtering...\n", suffix_count > "/dev/stderr"
            total = 0
            filtered = 0
            kept = 0
          }
          {
            domain = $0
            total++
            keep = 1
            
            if (domain in suffixes) {
              keep = 0
            } else {
              temp = domain
              while (match(temp, /\./)) {
                temp = substr(temp, RSTART + 1)
                if (temp in suffixes) {
                  keep = 0
                  break
                }
              }
            }
            
            if (keep) {
              kept++
              print $0
            } else {
              filtered++
            }
          }
          END {
            printf "Total: %d | Kept: %d (%.1f%%) | Filtered: %d (%.1f%%)\n", total, kept, (kept/total)*100, filtered, (filtered/total)*100 > "/dev/stderr"
          }
          AWK
          awk -f filter_domains.awk top-1m.domain > 1m.domain

      - name: Download gfw ip list and add reserved ranges
        shell: bash
        run: |
          set -euo pipefail
          curl -L https://raw.githubusercontent.com/pmkol/easymosdns/rules/gfw_ip_list.txt -o gfw_ipcidr.txt
          cp gfw_ipcidr.txt gfw.ipcidr
          cat >> gfw.ipcidr <<'EOF'
          0.0.0.0/8
          10.0.0.0/8
          100.64.0.0/10
          127.0.0.0/8
          169.254.0.0/16
          172.16.0.0/12
          192.0.0.0/24
          192.0.2.0/24
          192.88.99.0/24
          192.168.0.0/16
          198.18.0.0/15
          198.51.100.0/24
          203.0.113.0/24
          224.0.0.0/4
          240.0.0.0/4
          EOF

      - name: Commit and push results to branch
        shell: bash
        run: |
          set -euo pipefail
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          if git ls-remote --exit-code --heads origin generated-files; then
            git checkout generated-files
          else
            git checkout -b generated-files
          fi

          git add 1m.domain gfw.ipcidr
          git commit -m "Weekly update: domains and gfw.ipcidr" || echo "No changes to commit"
          git push origin generated-files