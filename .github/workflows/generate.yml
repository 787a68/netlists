name: Generate domain and IP list

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * 1"  # 每周一凌晨3点

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update -qq
          sudo apt-get install -y unzip curl dos2unix

      - name: Download and process Tranco top-1m list
        shell: bash
        run: |
          set -euo pipefail
          curl -fsSL https://tranco-list.eu/top-1m.csv.zip -o top-1m.csv.zip
          unzip -oq top-1m.csv.zip
          cut -d',' -f2 top-1m.csv > top-1m.domain
          dos2unix -q top-1m.domain 2>/dev/null || true

      - name: Download and normalize direct-list
        shell: bash
        run: |
          set -euo pipefail
          curl -fsSL https://raw.githubusercontent.com/Loyalsoldier/v2ray-rules-dat/release/direct-list.txt -o direct-list.txt
          sed -i \
            -e '/^regexp:/d' \
            -e 's/^full://g' \
            -e 's/^[[:space:]]\+//;s/[[:space:]]\+$//' \
            -e 's/#.*$//' \
            -e '/^$/d' \
            direct-list.txt
          sort -u direct-list.txt -o direct-list.txt

      - name: Filter domains with suffix matching
        shell: bash
        run: |
          set -euo pipefail
          cat > filter_domains.awk <<'AWK'
          BEGIN {
            while ((getline line < "direct-list.txt") > 0) {
              if (line != "") {
                gsub(/^[[:space:]]+|[[:space:]]+$/, "", line)
                if (line != "") suffixes[line] = 1
              }
            }
            close("direct-list.txt")
          }
          {
            domain = $0
            gsub(/^[[:space:]]+|[[:space:]]+$/, "", domain)
            if (domain == "") next
            
            keep = 1
            if (domain in suffixes) {
              keep = 0
            } else {
              temp = domain
              while (match(temp, /\./)) {
                temp = substr(temp, RSTART + 1)
                if (temp in suffixes) {
                  keep = 0
                  break
                }
              }
            }
            if (keep) print domain
          }
          AWK
          
          awk -f filter_domains.awk top-1m.domain > 1m.domain.tmp
          sort -u 1m.domain.tmp -o 1m.domain
          rm -f 1m.domain.tmp filter_domains.awk

      - name: Generate GFW IP CIDR list
        shell: bash
        run: |
          set -euo pipefail
          curl -fsSL https://raw.githubusercontent.com/pmkol/easymosdns/rules/gfw_ip_list.txt -o gfw_ipcidr.txt
          cp gfw_ipcidr.txt gfw.ipcidr
          cat >> gfw.ipcidr <<'EOF'
0.0.0.0/8
10.0.0.0/8
100.64.0.0/10
127.0.0.0/8
169.254.0.0/16
172.16.0.0/12
192.0.0.0/24
192.0.2.0/24
192.88.99.0/24
192.168.0.0/16
198.18.0.0/15
198.51.100.0/24
203.0.113.0/24
224.0.0.0/4
240.0.0.0/4
EOF

      - name: Commit and push to release branch
        shell: bash
        run: |
          set -euo pipefail
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # 切换到 release 分支
          if git ls-remote --exit-code --heads origin release >/dev/null 2>&1; then
            git fetch origin release
            git checkout release
            git reset --hard origin/release
          else
            git checkout --orphan release
            git rm -rf . 2>/dev/null || true
          fi

          # 复制文件到 release 分支
          cp 1m.domain gfw.ipcidr .
          
          # 提交并推送
          git add 1m.domain gfw.ipcidr
          
          if ! git diff --staged --quiet; then
            git commit -m "Update: $(wc -l < 1m.domain) domains, $(wc -l < gfw.ipcidr) IP ranges"
            git push -f origin release
          fi