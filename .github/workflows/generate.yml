name: Generate domain and IP list

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * 1"  # æ¯å‘¨ä¸€å‡Œæ™¨3ç‚¹

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y unzip curl

      - name: Download Tranco top-1m list
        shell: bash
        run: |
          set -euo pipefail
          curl -L https://tranco-list.eu/top-1m.csv.zip -o top-1m.csv.zip
          unzip -o top-1m.csv.zip
          # åªä¿ç•™åŸŸååˆ—
          cut -d',' -f2 top-1m.csv > top-1m.domain
          echo "ğŸ“Š top-1m.domain: $(wc -l < top-1m.domain) lines, $(stat -f%z top-1m.domain 2>/dev/null || stat -c%s top-1m.domain) bytes"

      - name: Download direct-list and normalize
        shell: bash
        run: |
          set -euo pipefail
          curl -L https://raw.githubusercontent.com/Loyalsoldier/v2ray-rules-dat/release/direct-list.txt -o direct-list.txt
          echo "ğŸ“¥ Downloaded direct-list.txt: $(wc -l < direct-list.txt) lines"
          
          # å»é™¤regexp:å¼€å¤´çš„è¡Œ
          sed -i '/^regexp:/d' direct-list.txt
          echo "ğŸ”§ After removing regexp lines: $(wc -l < direct-list.txt) lines"
          
          # å»é™¤å¼€å¤´çš„full:
          sed -i 's/^full://g' direct-list.txt
          echo "ğŸ”§ After removing full: prefix: $(wc -l < direct-list.txt) lines"
          
          # å»é™¤æ³¨é‡Šã€ç©ºè¡Œä¸å‰åç©ºç™½
          sed -i 's/^[[:space:]]\+//;s/[[:space:]]\+$//' direct-list.txt
          sed -i '/^$/d' direct-list.txt
          sed -i 's/#.*$//' direct-list.txt
          sed -i '/^$/d' direct-list.txt
          echo "ğŸ”§ After cleaning: $(wc -l < direct-list.txt) lines"
          
          # å»é‡å¹¶æ’åº
          sort -u direct-list.txt -o direct-list.txt
          echo "âœ… Final direct-list.txt: $(wc -l < direct-list.txt) lines, $(stat -f%z direct-list.txt 2>/dev/null || stat -c%s direct-list.txt) bytes"
          
          # è°ƒè¯•ï¼šæ˜¾ç¤ºå‰10è¡Œ
          echo "ğŸ” First 10 lines of direct-list.txt:"
          head -10 direct-list.txt | cat -A
          
          # è°ƒè¯•ï¼šæ£€æŸ¥æ˜¯å¦æœ‰baidu.com
          if grep -q "^baidu.com$" direct-list.txt; then
            echo "âœ“ Found baidu.com in direct-list.txt"
          else
            echo "âœ— baidu.com NOT found in direct-list.txt"
          fi

      - name: Filter domains with suffix matching (optimized)
        shell: bash
        run: |
          set -euo pipefail
          
          # è°ƒè¯•ï¼šæ˜¾ç¤ºtop-1m.domainçš„å‰10è¡Œ
          echo "ğŸ” First 10 lines of top-1m.domain:"
          head -10 top-1m.domain | cat -A
          
          cat > filter_domains.awk <<'AWK'
          BEGIN {
            suffix_count = 0
            debug_count = 0
            while ((getline line < "direct-list.txt") > 0) {
              if (line != "") {
                # ç¡®ä¿å»é™¤æ‰€æœ‰ç©ºç™½å­—ç¬¦
                gsub(/^[[:space:]]+|[[:space:]]+$/, "", line)
                if (line != "") {
                  suffixes[line] = 1
                  suffix_count++
                  # è°ƒè¯•ï¼šè¾“å‡ºå‰5ä¸ªåç¼€
                  if (debug_count < 5) {
                    printf "  Debug suffix[%d]: [%s]\n", debug_count, line > "/dev/stderr"
                    debug_count++
                  }
                }
              }
            }
            close("direct-list.txt")
            printf "ğŸ” Loaded %d suffixes for filtering\n", suffix_count > "/dev/stderr"
            total = 0
            filtered = 0
            kept = 0
            match_examples = 0
          }
          {
            domain = $0
            # ç¡®ä¿å»é™¤æ‰€æœ‰ç©ºç™½å­—ç¬¦
            gsub(/^[[:space:]]+|[[:space:]]+$/, "", domain)
            if (domain == "") next
            
            total++
            keep = 1
            
            if (domain in suffixes) {
              keep = 0
              if (match_examples < 3) {
                printf "  Match example: [%s] exact match\n", domain > "/dev/stderr"
                match_examples++
              }
            } else {
              temp = domain
              while (match(temp, /\./)) {
                temp = substr(temp, RSTART + 1)
                if (temp in suffixes) {
                  keep = 0
                  if (match_examples < 3) {
                    printf "  Match example: [%s] matched by suffix [%s]\n", domain, temp > "/dev/stderr"
                    match_examples++
                  }
                  break
                }
              }
            }
            
            if (keep) {
              kept++
              print domain
            } else {
              filtered++
            }
          }
          END {
            printf "ğŸ“Š Total: %d | Kept: %d (%.1f%%) | Filtered: %d (%.1f%%)\n", total, kept, (kept/total)*100, filtered, (filtered/total)*100 > "/dev/stderr"
          }
          AWK
          awk -f filter_domains.awk top-1m.domain > 1m.domain.tmp
          
          # å»é‡
          sort -u 1m.domain.tmp -o 1m.domain
          rm 1m.domain.tmp
          echo "âœ… Final 1m.domain: $(wc -l < 1m.domain) lines, $(stat -f%z 1m.domain 2>/dev/null || stat -c%s 1m.domain) bytes"

      - name: Download gfw ip list and add reserved ranges
        shell: bash
        run: |
          set -euo pipefail
          curl -L https://raw.githubusercontent.com/pmkol/easymosdns/rules/gfw_ip_list.txt -o gfw_ipcidr.txt
          echo "ğŸ“¥ Downloaded gfw_ipcidr.txt: $(wc -l < gfw_ipcidr.txt) lines"
          
          cp gfw_ipcidr.txt gfw.ipcidr
          cat >> gfw.ipcidr <<'EOF'
          0.0.0.0/8
          10.0.0.0/8
          100.64.0.0/10
          127.0.0.0/8
          169.254.0.0/16
          172.16.0.0/12
          192.0.0.0/24
          192.0.2.0/24
          192.88.99.0/24
          192.168.0.0/16
          198.18.0.0/15
          198.51.100.0/24
          203.0.113.0/24
          224.0.0.0/4
          240.0.0.0/4
          EOF
          echo "âœ… Final gfw.ipcidr: $(wc -l < gfw.ipcidr) lines, $(stat -f%z gfw.ipcidr 2>/dev/null || stat -c%s gfw.ipcidr) bytes"

      - name: Commit and push results to branch
        shell: bash
        run: |
          set -euo pipefail
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          if git ls-remote --exit-code --heads origin generated-files; then
            git checkout generated-files
          else
            git checkout -b generated-files
          fi

          git add 1m.domain gfw.ipcidr
          git commit -m "Weekly update: domains and gfw.ipcidr" || echo "No changes to commit"
          git push origin generated-files