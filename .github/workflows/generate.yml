name: Generate domain and IP list

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * 1"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y unzip curl dos2unix

      - name: Download and process source files
        run: |
          # ä¸‹è½½ Tranco 1m åˆ—è¡¨
          curl -fsSL https://tranco-list.eu/top-1m-incl-subdomains.csv.zip -o top-1m.csv.zip
          unzip -qo top-1m.csv.zip
          cut -d',' -f2 top-1m.csv | dos2unix 2>/dev/null > top-1m.domain
          echo "ðŸ“„ top-1m.domain: $(wc -l < top-1m.domain) è¡Œ"

          # å®šä¹‰æ ‡å‡†åŒ–å‡½æ•°
          normalize_rules() {
            sed -e '/^regexp:/d' \
                -e 's/^full://g' \
                -e 's/^[[:space:]]\+//;s/[[:space:]]\+$//' \
                -e 's/#.*$//' \
                -e '/^$/d' "$1" | sort -u
          }

          # ä¸‹è½½å¹¶æ ‡å‡†åŒ–è§„åˆ™æ–‡ä»¶
          curl -fsSL https://raw.githubusercontent.com/Loyalsoldier/v2ray-rules-dat/release/reject-list.txt -o reject-list.txt
          normalize_rules reject-list.txt > reject-list.txt.tmp && mv reject-list.txt.tmp reject-list.txt
          echo "ðŸ“„ reject-list.txt: $(wc -l < reject-list.txt) è¡Œ"

          curl -fsSL https://raw.githubusercontent.com/Loyalsoldier/v2ray-rules-dat/release/gfw.txt -o gfw-list.txt
          normalize_rules gfw-list.txt > gfw-list.txt.tmp && mv gfw-list.txt.tmp gfw-list.txt
          echo "ðŸ“„ gfw-list.txt: $(wc -l < gfw-list.txt) è¡Œ"

          curl -fsSL https://raw.githubusercontent.com/Loyalsoldier/v2ray-rules-dat/release/direct-list.txt -o direct-list.txt
          normalize_rules direct-list.txt > direct-list.txt.tmp && mv direct-list.txt.tmp direct-list.txt
          echo "ðŸ“„ direct-list.txt: $(wc -l < direct-list.txt) è¡Œ"

      # ... [å…¶ä»–å¤„ç†æ­¥éª¤ä¿æŒä¸å˜] ...

      - name: Generate GFW IP CIDR list
        run: |
          curl -fsSL https://raw.githubusercontent.com/pmkol/easymosdns/rules/gfw_ip_list.txt -o gfw.ipcidr
          cat >> gfw.ipcidr <<'EOF'
          0.0.0.0/8
          10.0.0.0/8
          100.64.0.0/10
          127.0.0.0/8
          169.254.0.0/16
          172.16.0.0/12
          192.0.0.0/24
          192.0.2.0/24
          192.88.99.0/24
          192.168.0.0/16
          198.18.0.0/15
          198.51.100.0/24
          203.0.113.0/24
          224.0.0.0/4
          240.0.0.0/4
          EOF
          echo "ðŸ“„ gfw.ipcidr: $(wc -l < gfw.ipcidr) è¡Œ"

      - name: Cleanup temporary files
        run: |
          rm -f top-1m.csv.zip top-1m.csv \
                reject-list.txt gfw-list.txt direct-list.txt \
                remaining-*.domain remaining-*.tmp

      - name: Create or update release
        env:
          GITHUB_TOKEN: $ github.token 
        run: |
          # å¦‚æžœ release ä¸å­˜åœ¨åˆ™åˆ›å»º
          gh release view latest >/dev/null 2>&1 || \
            gh release create latest --title "Latest Release" --notes ""
          
          # ä½¿ç”¨ --clobber è¦†ç›–å·²å­˜åœ¨çš„æ–‡ä»¶
          gh release upload latest *.domain *.list *.ipcidr --clobber