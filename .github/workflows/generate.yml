name: Generate domain and IP list

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * 1"  # æ¯å‘¨ä¸€å‡Œæ™¨3ç‚¹

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update -qq
          sudo apt-get install -y unzip curl dos2unix

      - name: Delete old release
        shell: bash
        env:
          GITHUB_TOKEN: $ secrets.GITHUB_TOKEN 
        run: |
          set -euo pipefail
          if gh release view latest 2>/dev/null; then
            echo "ğŸ—‘ï¸  åˆ é™¤æ—§ release..."
            gh release delete latest --yes --cleanup-tag 2>/dev/null || true
          else
            echo "â„¹ï¸  æ²¡æœ‰æ‰¾åˆ°æ—§ release"
          fi

      - name: Download and process Tranco top-1m list
        shell: bash
        run: |
          set -euo pipefail
          curl -fsSL https://tranco-list.eu/top-1m-incl-subdomains.csv.zip -o top-1m.csv.zip
          unzip -oq top-1m.csv.zip
          cut -d',' -f2 top-1m.csv > top-1m.domain
          dos2unix -q top-1m.domain 2>/dev/null || true
          echo "ğŸ“„ top-1m.domain (åŸå§‹): $(wc -l < top-1m.domain) lines, $(du -h top-1m.domain | cut -f1)"

      - name: Deduplicate top-1m domains by suffix matching
        shell: bash
        run: |
          set -euo pipefail
          cat > deduplicate.awk <<'AWK'
          BEGIN {
            while ((getline line < "top-1m.domain") > 0) {
              if (line != "") {
                gsub(/^[[:space:]]+|[[:space:]]+$/, "", line)
                if (line != "") domains[line] = 1
              }
            }
            close("top-1m.domain")
            
            for (domain in domains) {
              keep = 1
              temp = domain
              while (match(temp, /\./)) {
                temp = substr(temp, RSTART + 1)
                if (temp in domains) {
                  keep = 0
                  break
                }
              }
              if (keep) print domain
            }
          }
          AWK
          
          awk -f deduplicate.awk > top-1m.domain.dedup
          sort -u top-1m.domain.dedup -o top-1m.domain
          rm -f top-1m.domain.dedup deduplicate.awk
          echo "ğŸ“„ top-1m.domain (å»é‡å): $(wc -l < top-1m.domain) lines, $(du -h top-1m.domain | cut -f1)"

      - name: Download and normalize reject-list
        shell: bash
        run: |
          set -euo pipefail
          curl -fsSL https://raw.githubusercontent.com/Loyalsoldier/v2ray-rules-dat/release/reject-list.txt -o reject-list.txt
          sed -i \
            -e '/^regexp:/d' \
            -e 's/^full://g' \
            -e 's/^[[:space:]]\+//;s/[[:space:]]\+$//' \
            -e 's/#.*$//' \
            -e '/^$/d' \
            reject-list.txt
          sort -u reject-list.txt -o reject-list.txt
          echo "ğŸ“„ reject-list.txt: $(wc -l < reject-list.txt) lines, $(du -h reject-list.txt | cut -f1)"

      - name: Download and normalize gfw-list
        shell: bash
        run: |
          set -euo pipefail
          curl -fsSL https://raw.githubusercontent.com/Loyalsoldier/v2ray-rules-dat/release/gfw.txt -o gfw-list.txt
          sed -i \
            -e '/^regexp:/d' \
            -e 's/^full://g' \
            -e 's/^[[:space:]]\+//;s/[[:space:]]\+$//' \
            -e 's/#.*$//' \
            -e '/^$/d' \
            gfw-list.txt
          sort -u gfw-list.txt -o gfw-list.txt
          echo "ğŸ“„ gfw-list.txt: $(wc -l < gfw-list.txt) lines, $(du -h gfw-list.txt | cut -f1)"

      - name: Download and normalize direct-list
        shell: bash
        run: |
          set -euo pipefail
          curl -fsSL https://raw.githubusercontent.com/Loyalsoldier/v2ray-rules-dat/release/direct-list.txt -o direct-list.txt
          sed -i \
            -e '/^regexp:/d' \
            -e 's/^full://g' \
            -e 's/^[[:space:]]\+//;s/[[:space:]]\+$//' \
            -e 's/#.*$//' \
            -e '/^$/d' \
            direct-list.txt
          sort -u direct-list.txt -o direct-list.txt
          echo "ğŸ“„ direct-list.txt: $(wc -l < direct-list.txt) lines, $(du -h direct-list.txt | cut -f1)"

      - name: Process reject domains with 1m pipeline
        shell: bash
        run: |
          set -euo pipefail
          cat > process_reject.awk <<'AWK'
          BEGIN {
            while ((getline line < "reject-list.txt") > 0) {
              if (line != "") {
                gsub(/^[[:space:]]+|[[:space:]]+$/, "", line)
                if (line != "") suffixes[line] = 1
              }
            }
            close("reject-list.txt")
          }
          {
            domain = $0
            gsub(/^[[:space:]]+|[[:space:]]+$/, "", domain)
            if (domain == "") next
            
            keep = 1
            matched_suffix = ""
            
            if (domain in suffixes) {
              keep = 0
              matched_suffix = domain
            } else {
              temp = domain
              while (match(temp, /\./)) {
                temp = substr(temp, RSTART + 1)
                if (temp in suffixes) {
                  keep = 0
                  matched_suffix = temp
                  break
                }
              }
            }
            
            if (!keep && matched_suffix != "") {
              matched_rules[matched_suffix] = 1
            } else if (keep) {
              print domain > "top-1m-after-reject.tmp"
            }
          }
          END {
            for (rule in matched_rules) {
              print rule > "reject.domain.tmp"
            }
          }
          AWK
          
          awk -f process_reject.awk top-1m.domain
          sort -u reject.domain.tmp -o reject.domain 2>/dev/null || touch reject.domain
          sort -u top-1m-after-reject.tmp -o top-1m-after-reject.domain 2>/dev/null || cp top-1m.domain top-1m-after-reject.domain
          rm -f reject.domain.tmp top-1m-after-reject.tmp process_reject.awk
          echo "ğŸ“„ reject.domain: $(wc -l < reject.domain) lines, $(du -h reject.domain | cut -f1)"

      - name: Process gfw/proxy domains with 1m pipeline and deduplicate with reject
        shell: bash
        run: |
          set -euo pipefail
          cat > process_gfw.awk <<'AWK'
          BEGIN {
            # åŠ è½½ reject è§„åˆ™ç”¨äºå»é‡
            while ((getline line < "reject.domain") > 0) {
              if (line != "") {
                gsub(/^[[:space:]]+|[[:space:]]+$/, "", line)
                if (line != "") reject_rules[line] = 1
              }
            }
            close("reject.domain")
            
            # åŠ è½½ gfw è§„åˆ™
            while ((getline line < "gfw-list.txt") > 0) {
              if (line != "") {
                gsub(/^[[:space:]]+|[[:space:]]+$/, "", line)
                if (line != "") suffixes[line] = 1
              }
            }
            close("gfw-list.txt")
          }
          {
            domain = $0
            gsub(/^[[:space:]]+|[[:space:]]+$/, "", domain)
            if (domain == "") next
            
            keep = 1
            matched_suffix = ""
            
            if (domain in suffixes) {
              keep = 0
              matched_suffix = domain
            } else {
              temp = domain
              while (match(temp, /\./)) {
                temp = substr(temp, RSTART + 1)
                if (temp in suffixes) {
                  keep = 0
                  matched_suffix = temp
                  break
                }
              }
            }
            
            if (!keep && matched_suffix != "") {
              # æ£€æŸ¥æ˜¯å¦å·²åœ¨ reject ä¸­
              is_in_reject = 0
              if (matched_suffix in reject_rules) {
                is_in_reject = 1
              } else {
                temp = matched_suffix
                while (match(temp, /\./)) {
                  temp = substr(temp, RSTART + 1)
                  if (temp in reject_rules) {
                    is_in_reject = 1
                    break
                  }
                }
              }
              
              if (!is_in_reject) {
                matched_rules[matched_suffix] = 1
              }
            } else if (keep) {
              print domain > "top-1m-after-gfw.tmp"
            }
          }
          END {
            for (rule in matched_rules) {
              print rule > "proxy.domain.tmp"
            }
          }
          AWK
          
          awk -f process_gfw.awk top-1m-after-reject.domain
          sort -u proxy.domain.tmp -o proxy.domain 2>/dev/null || touch proxy.domain
          sort -u top-1m-after-gfw.tmp -o top-1m-after-gfw.domain 2>/dev/null || cp top-1m-after-reject.domain top-1m-after-gfw.domain
          rm -f proxy.domain.tmp top-1m-after-gfw.tmp process_gfw.awk
          echo "ğŸ“„ proxy.domain: $(wc -l < proxy.domain) lines, $(du -h proxy.domain | cut -f1)"

      - name: Process direct domains with 1m pipeline and deduplicate with reject+gfw
        shell: bash
        run: |
          set -euo pipefail
          cat > process_direct.awk <<'AWK'
          BEGIN {
            # åŠ è½½ reject è§„åˆ™ç”¨äºå»é‡
            while ((getline line < "reject.domain") > 0) {
              if (line != "") {
                gsub(/^[[:space:]]+|[[:space:]]+$/, "", line)
                if (line != "") existing_rules[line] = 1
              }
            }
            close("reject.domain")
            
            # åŠ è½½ proxy è§„åˆ™ç”¨äºå»é‡
            while ((getline line < "proxy.domain") > 0) {
              if (line != "") {
                gsub(/^[[:space:]]+|[[:space:]]+$/, "", line)
                if (line != "") existing_rules[line] = 1
              }
            }
            close("proxy.domain")
            
            # åŠ è½½ direct è§„åˆ™
            while ((getline line < "direct-list.txt") > 0) {
              if (line != "") {
                gsub(/^[[:space:]]+|[[:space:]]+$/, "", line)
                if (line != "") suffixes[line] = 1
              }
            }
            close("direct-list.txt")
          }
          {
            domain = $0
            gsub(/^[[:space:]]+|[[:space:]]+$/, "", domain)
            if (domain == "") next
            
            keep = 1
            matched_suffix = ""
            
            if (domain in suffixes) {
              keep = 0
              matched_suffix = domain
            } else {
              temp = domain
              while (match(temp, /\./)) {
                temp = substr(temp, RSTART + 1)
                if (temp in suffixes) {
                  keep = 0
                  matched_suffix = temp
                  break
                }
              }
            }
            
            if (!keep && matched_suffix != "") {
              # æ£€æŸ¥æ˜¯å¦å·²åœ¨ reject æˆ– proxy ä¸­
              is_in_existing = 0
              if (matched_suffix in existing_rules) {
                is_in_existing = 1
              } else {
                temp = matched_suffix
                while (match(temp, /\./)) {
                  temp = substr(temp, RSTART + 1)
                  if (temp in existing_rules) {
                    is_in_existing = 1
                    break
                  }
                }
              }
              
              if (!is_in_existing) {
                matched_rules[matched_suffix] = 1
              }
            } else if (keep) {
              print domain > "1m-other.list.tmp"
            }
          }
          END {
            for (rule in matched_rules) {
              print rule > "direct.domain.tmp"
            }
          }
          AWK
          
          awk -f process_direct.awk top-1m-after-gfw.domain
          sort -u direct.domain.tmp -o direct.domain 2>/dev/null || touch direct.domain
          sort -u 1m-other.list.tmp -o 1m-other.list 2>/dev/null || touch 1m-other.list
          rm -f direct.domain.tmp 1m-other.list.tmp process_direct.awk
          echo "ğŸ“„ direct.domain: $(wc -l < direct.domain) lines, $(du -h direct.domain | cut -f1)"
          echo "ğŸ“„ 1m-other.list: $(wc -l < 1m-other.list) lines, $(du -h 1m-other.list | cut -f1)"

      - name: Generate GFW IP CIDR list
        shell: bash
        run: |
          set -euo pipefail
          curl -fsSL https://raw.githubusercontent.com/pmkol/easymosdns/rules/gfw_ip_list.txt -o gfw_ipcidr.txt
          echo "ğŸ“„ gfw_ipcidr.txt: $(wc -l < gfw_ipcidr.txt) lines, $(du -h gfw_ipcidr.txt | cut -f1)"
          cp gfw_ipcidr.txt gfw.ipcidr
          cat >> gfw.ipcidr <<'EOF'
          0.0.0.0/8
          10.0.0.0/8
          100.64.0.0/10
          127.0.0.0/8
          169.254.0.0/16
          172.16.0.0/12
          192.0.0.0/24
          192.0.2.0/24
          192.88.99.0/24
          192.168.0.0/16
          198.18.0.0/15
          198.51.100.0/24
          203.0.113.0/24
          224.0.0.0/4
          240.0.0.0/4
          EOF
          echo "ğŸ“„ gfw.ipcidr: $(wc -l < gfw.ipcidr) lines, $(du -h gfw.ipcidr | cut -f1)"

      - name: Create new release and upload files
        shell: bash
        env:
          GITHUB_TOKEN: $ secrets.GITHUB_TOKEN 
        run: |
          set -euo pipefail
          
          echo "ğŸ“¦ åˆ›å»ºæ–° release å¹¶ä¸Šä¼ æ–‡ä»¶..."
          RELEASE_MSG="è‡ªåŠ¨æ›´æ–° - $(date -u +'%Y-%m-%d %H:%M:%S UTC')

          ğŸ“Š ç»Ÿè®¡ä¿¡æ¯:
          - reject.domain: $(wc -l < reject.domain) æ¡è§„åˆ™
          - proxy.domain: $(wc -l < proxy.domain) æ¡è§„åˆ™
          - direct.domain: $(wc -l < direct.domain) æ¡è§„åˆ™
          - 1m-other.list: $(wc -l < 1m-other.list) æ¡åŸŸå
          - gfw.ipcidr: $(wc -l < gfw.ipcidr) æ¡ IP è§„åˆ™"
          
          gh release create latest \
            --title "Latest Release" \
            --notes "$RELEASE_MSG" \
            reject.domain proxy.domain direct.domain 1m-other.list gfw.ipcidr
          
          echo "âœ… å·²åˆ›å»ºæ–° release å¹¶ä¸Šä¼ æ‰€æœ‰æ–‡ä»¶"
          echo "ğŸ“„ reject.domain: $(wc -l < reject.domain) lines, $(du -h reject.domain | cut -f1)"
          echo "ğŸ“„ proxy.domain: $(wc -l < proxy.domain) lines, $(du -h proxy.domain | cut -f1)"
          echo "ğŸ“„ direct.domain: $(wc -l < direct.domain) lines, $(du -h direct.domain | cut -f1)"
          echo "ğŸ“„ 1m-other.list: $(wc -l < 1m-other.list) lines, $(du -h 1m-other.list | cut -f1)"
          echo "ğŸ“„ gfw.ipcidr: $(wc -l < gfw.ipcidr) lines, $(du -h gfw.ipcidr | cut -f1)"