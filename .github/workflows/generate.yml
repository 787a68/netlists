name: Generate domain and IP list

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * 1"  # æ¯å‘¨ä¸€å‡Œæ™¨3ç‚¹

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update -qq
          sudo apt-get install -y unzip curl dos2unix

      - name: Download and process Tranco top-1m list
        shell: bash
        run: |
          set -euo pipefail
          curl -fsSL https://tranco-list.eu/top-1m.csv.zip -o top-1m.csv.zip
          unzip -oq top-1m.csv.zip
          cut -d',' -f2 top-1m.csv > top-1m.domain
          dos2unix -q top-1m.domain 2>/dev/null || true
          echo "ğŸ“„ top-1m.domain: $(wc -l < top-1m.domain) lines, $(du -h top-1m.domain | cut -f1)"

      - name: Download and normalize direct-list
        shell: bash
        run: |
          set -euo pipefail
          curl -fsSL https://raw.githubusercontent.com/Loyalsoldier/v2ray-rules-dat/release/direct-list.txt -o direct-list.txt
          sed -i \
            -e '/^regexp:/d' \
            -e 's/^full://g' \
            -e 's/^[[:space:]]\+//;s/[[:space:]]\+$//' \
            -e 's/#.*$//' \
            -e '/^$/d' \
            direct-list.txt
          sort -u direct-list.txt -o direct-list.txt
          echo "ğŸ“„ direct-list.txt: $(wc -l < direct-list.txt) lines, $(du -h direct-list.txt | cut -f1)"

      - name: Filter domains and find matched direct-list entries
        shell: bash
        run: |
          set -euo pipefail
          cat > filter_domains.awk <<'AWK'
          BEGIN {
            # è¯»å– top-1m åŸŸååˆ°æ•°ç»„
            while ((getline line < "top-1m.domain") > 0) {
              if (line != "") {
                gsub(/^[[:space:]]+|[[:space:]]+$/, "", line)
                if (line != "") domains[line] = 1
              }
            }
            close("top-1m.domain")
          }
          {
            # å¤„ç† direct-list ä¸­çš„æ¯ä¸ªè§„åˆ™
            suffix = $0
            gsub(/^[[:space:]]+|[[:space:]]+$/, "", suffix)
            if (suffix == "") next
            
            matched = 0
            # æ£€æŸ¥æ˜¯å¦æœ‰åŸŸååŒ¹é…è¿™ä¸ªè§„åˆ™
            for (domain in domains) {
              if (domain == suffix) {
                matched = 1
                delete domains[domain]
              } else if (match(domain, "\\." suffix "$")) {
                matched = 1
                delete domains[domain]
              }
            }
            
            # å¦‚æœåŒ¹é…åˆ°äº†ï¼Œè®°å½•è¿™ä¸ª direct-list è§„åˆ™
            if (matched) {
              print suffix > "direct.domain.tmp"
            }
          }
          END {
            # å‰©ä½™æœªåŒ¹é…çš„åŸŸåè¾“å‡ºåˆ° 1m.domain
            for (domain in domains) {
              print domain > "1m.domain.tmp"
            }
          }
          AWK
          
          awk -f filter_domains.awk direct-list.txt
          sort -u 1m.domain.tmp -o 1m.domain
          sort -u direct.domain.tmp -o direct.domain
          rm -f 1m.domain.tmp direct.domain.tmp filter_domains.awk
          echo "ğŸ“„ 1m.domain: $(wc -l < 1m.domain) lines, $(du -h 1m.domain | cut -f1)"
          echo "ğŸ“„ direct.domain: $(wc -l < direct.domain) lines, $(du -h direct.domain | cut -f1)"

      - name: Generate GFW IP CIDR list
        shell: bash
        run: |
          set -euo pipefail
          curl -fsSL https://raw.githubusercontent.com/pmkol/easymosdns/rules/gfw_ip_list.txt -o gfw_ipcidr.txt
          echo "ğŸ“„ gfw_ipcidr.txt: $(wc -l < gfw_ipcidr.txt) lines, $(du -h gfw_ipcidr.txt | cut -f1)"
          cp gfw_ipcidr.txt gfw.ipcidr
          cat >> gfw.ipcidr <<'EOF'
          0.0.0.0/8
          10.0.0.0/8
          100.64.0.0/10
          127.0.0.0/8
          169.254.0.0/16
          172.16.0.0/12
          192.0.0.0/24
          192.0.2.0/24
          192.88.99.0/24
          192.168.0.0/16
          198.18.0.0/15
          198.51.100.0/24
          203.0.113.0/24
          224.0.0.0/4
          240.0.0.0/4
          EOF
          echo "ğŸ“„ gfw.ipcidr: $(wc -l < gfw.ipcidr) lines, $(du -h gfw.ipcidr | cut -f1)"

      - name: Commit and push to release branch
        shell: bash
        run: |
          set -euo pipefail
          git config --global user.name "actions-user"
          git config --global user.email "actions@github.com"

          # åˆ‡æ¢åˆ° release åˆ†æ”¯
          if git ls-remote --exit-code --heads origin release >/dev/null 2>&1; then
            git fetch origin release
            git checkout release
            git reset --hard origin/release
          else
            git checkout --orphan release
            git rm -rf . 2>/dev/null || true
          fi

          # æäº¤å¹¶æ¨é€
          git add 1m.domain direct.domain gfw.ipcidr

          if ! git diff --staged --quiet; then
            git commit -m "Update: $(wc -l < 1m.domain) domains, $(wc -l < direct.domain) direct rules, $(wc -l < gfw.ipcidr) IP ranges"
            git push -f origin release
            echo "âœ… å·²æ¨é€åˆ° release åˆ†æ”¯"
            echo "ğŸ“„ 1m.domain: $(wc -l < 1m.domain) lines, $(du -h 1m.domain | cut -f1)"
            echo "ğŸ“„ direct.domain: $(wc -l < direct.domain) lines, $(du -h direct.domain | cut -f1)"
            echo "ğŸ“„ gfw.ipcidr: $(wc -l < gfw.ipcidr) lines, $(du -h gfw.ipcidr | cut -f1)"
          fi