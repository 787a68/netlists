name: Generate domain and IP list

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * 1"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # æ£€å‡º release åˆ†æ”¯ï¼ˆå¦‚æœä¸å­˜åœ¨ä¼šè‡ªåŠ¨åˆ›å»ºï¼‰
      - name: Checkout release branch
        uses: actions/checkout@v4
        with:
          ref: release
          fetch-depth: 1

      # æ¸…ç©ºæ—§äº§ç‰©ï¼ˆä¿ç•™ .githubï¼‰
      - name: Purge previous files keep .github
        shell: bash
        run: |
          set -euo pipefail
          git rm -r --ignore-unmatch . ':(exclude).github' || true
          find . -mindepth 1 -maxdepth 1 \
            -not -name '.git' \
            -not -name '.github' \
            -exec rm -rf {} +

      - name: Install dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y unzip curl dos2unix

      - name: Download and process source files
        run: |
          # ä¸‹è½½ Tranco 1m åˆ—è¡¨
          curl -fsSL https://tranco-list.eu/top-1m-incl-subdomains.csv.zip -o top-1m.csv.zip
          unzip -qo top-1m.csv.zip
          cut -d',' -f2 top-1m.csv | dos2unix 2>/dev/null > top-1m.domain
          echo "ğŸ“„ top-1m.domain: $(wc -l < top-1m.domain) è¡Œ"

          # å®šä¹‰æ ‡å‡†åŒ–å‡½æ•°
          normalize_rules() {
            sed -e '/^regexp:/d' \
                -e 's/^full://g' \
                -e 's/^[[:space:]]\+//;s/[[:space:]]\+$//' \
                -e 's/#.*$//' \
                -e '/^$/d' "$1" | sort -u
          }

          # ä¸‹è½½å¹¶æ ‡å‡†åŒ–è§„åˆ™æ–‡ä»¶
          curl -fsSL https://raw.githubusercontent.com/Loyalsoldier/v2ray-rules-dat/release/reject-list.txt -o reject-list.txt
          normalize_rules reject-list.txt > reject-list.txt.tmp && mv reject-list.txt.tmp reject-list.txt
          echo "ğŸ“„ reject-list.txt: $(wc -l < reject-list.txt) è¡Œ"

          # ä¸‹è½½ surge reject.domain å¹¶åˆå¹¶åˆ° reject-list
          curl -fsSL https://raw.githubusercontent.com/787a68/surge/rule/reject.domain -o surge-reject.tmp
          # å»é™¤æ¯è¡Œå¼€å¤´çš„ç‚¹
          sed 's/^\.//' surge-reject.tmp | normalize_rules - >> reject-list.txt.tmp2
          cat reject-list.txt >> reject-list.txt.tmp2
          sort -u reject-list.txt.tmp2 > reject-list.txt
          rm -f surge-reject.tmp reject-list.txt.tmp2
          echo "ğŸ“„ reject-list.txt (åˆå¹¶ surge): $(wc -l < reject-list.txt) è¡Œ"

          curl -fsSL https://raw.githubusercontent.com/Loyalsoldier/v2ray-rules-dat/release/gfw.txt -o gfw-list.txt
          normalize_rules gfw-list.txt > gfw-list.txt.tmp && mv gfw-list.txt.tmp gfw-list.txt
          echo "ğŸ“„ gfw-list.txt: $(wc -l < gfw-list.txt) è¡Œ"

          curl -fsSL https://raw.githubusercontent.com/Loyalsoldier/v2ray-rules-dat/release/direct-list.txt -o direct-list.txt
          normalize_rules direct-list.txt > direct-list.txt.tmp && mv direct-list.txt.tmp direct-list.txt
          echo "ğŸ“„ direct-list.txt: $(wc -l < direct-list.txt) è¡Œ"

      - name: Deduplicate 1m domains by suffix
        run: |
          awk 'BEGIN {
            while ((getline < "top-1m.domain") > 0) {
              gsub(/^[[:space:]]+|[[:space:]]+$/, "")
              if ($0 != "") domains[$0] = 1
            }
            for (domain in domains) {
              keep = 1
              temp = domain
              while (match(temp, /\./)) {
                temp = substr(temp, RSTART + 1)
                if (temp in domains) { keep = 0; break }
              }
              if (keep) print domain
            }
          }' | sort -u > top-1m.domain.tmp
          mv top-1m.domain.tmp top-1m.domain
          echo "ğŸ“„ top-1m.domain (åç¼€å»é‡): $(wc -l < top-1m.domain) è¡Œ"

      - name: Process reject domains (Step 1)
        run: |
          awk 'BEGIN {
            while ((getline < "reject-list.txt") > 0) {
              gsub(/^[[:space:]]+|[[:space:]]+$/, "")
              if ($0 != "") rules[$0] = 1
            }
          }
          {
            gsub(/^[[:space:]]+|[[:space:]]+$/, "")
            if ($0 == "") next
            
            matched = 0
            if ($0 in rules) { matched_rules[$0] = 1; matched = 1 }
            else {
              temp = $0
              while (match(temp, /\./)) {
                temp = substr(temp, RSTART + 1)
                if (temp in rules) { matched_rules[temp] = 1; matched = 1; break }
              }
            }
            if (!matched) print > "remaining-1.tmp"
          }
          END {
            for (r in matched_rules) print r > "reject.domain"
          }
          ' top-1m.domain
          
          sort -u reject.domain -o reject.domain 2>/dev/null || touch reject.domain
          sort -u remaining-1.tmp -o remaining-1.domain 2>/dev/null || cp top-1m.domain remaining-1.domain
          echo "ğŸ“„ reject.domain: $(wc -l < reject.domain) è¡Œ"
          echo "ğŸ“„ remaining-1.domain (ç¬¬1æ¬¡å»é‡å): $(wc -l < remaining-1.domain) è¡Œ"

      - name: Process gfw/proxy domains (Step 2)
        run: |
          awk 'BEGIN {
            while ((getline < "reject.domain") > 0) {
              gsub(/^[[:space:]]+|[[:space:]]+$/, "")
              if ($0 != "") exclusions[$0] = 1
            }
            while ((getline < "gfw-list.txt") > 0) {
              gsub(/^[[:space:]]+|[[:space:]]+$/, "")
              if ($0 != "") rules[$0] = 1
            }
          }
          {
            gsub(/^[[:space:]]+|[[:space:]]+$/, "")
            if ($0 == "") next
            
            matched = 0
            matched_rule = ""
            if ($0 in rules) { matched = 1; matched_rule = $0 }
            else {
              temp = $0
              while (match(temp, /\./)) {
                temp = substr(temp, RSTART + 1)
                if (temp in rules) { matched = 1; matched_rule = temp; break }
              }
            }
            
            if (matched && matched_rule != "") {
              is_excluded = 0
              if (matched_rule in exclusions) is_excluded = 1
              else {
                temp = matched_rule
                while (match(temp, /\./)) {
                  temp = substr(temp, RSTART + 1)
                  if (temp in exclusions) { is_excluded = 1; break }
                }
              }
              if (!is_excluded) matched_rules[matched_rule] = 1
            } else {
              print > "remaining-2.tmp"
            }
          }
          END {
            for (r in matched_rules) print r > "proxy.domain"
          }
          ' remaining-1.domain
          
          sort -u proxy.domain -o proxy.domain 2>/dev/null || touch proxy.domain
          sort -u remaining-2.tmp -o remaining-2.domain 2>/dev/null || cp remaining-1.domain remaining-2.domain
          echo "ğŸ“„ proxy.domain: $(wc -l < proxy.domain) è¡Œ"
          echo "ğŸ“„ remaining-2.domain (ç¬¬2æ¬¡å»é‡å): $(wc -l < remaining-2.domain) è¡Œ"

      - name: Process direct domains (Step 3)
        run: |
          awk 'BEGIN {
            while ((getline < "reject.domain") > 0) {
              gsub(/^[[:space:]]+|[[:space:]]+$/, "")
              if ($0 != "") exclusions[$0] = 1
            }
            while ((getline < "proxy.domain") > 0) {
              gsub(/^[[:space:]]+|[[:space:]]+$/, "")
              if ($0 != "") exclusions[$0] = 1
            }
            while ((getline < "direct-list.txt") > 0) {
              gsub(/^[[:space:]]+|[[:space:]]+$/, "")
              if ($0 != "") rules[$0] = 1
            }
          }
          {
            gsub(/^[[:space:]]+|[[:space:]]+$/, "")
            if ($0 == "") next
            
            matched = 0
            matched_rule = ""
            if ($0 in rules) { matched = 1; matched_rule = $0 }
            else {
              temp = $0
              while (match(temp, /\./)) {
                temp = substr(temp, RSTART + 1)
                if (temp in rules) { matched = 1; matched_rule = temp; break }
              }
            }
            
            if (matched && matched_rule != "") {
              is_excluded = 0
              if (matched_rule in exclusions) is_excluded = 1
              else {
                temp = matched_rule
                while (match(temp, /\./)) {
                  temp = substr(temp, RSTART + 1)
                  if (temp in exclusions) { is_excluded = 1; break }
                }
              }
              if (!is_excluded) matched_rules[matched_rule] = 1
            } else {
              print > "1m-other.list"
            }
          }
          END {
            for (r in matched_rules) print r > "direct.domain"
          }
          ' remaining-2.domain
          
          sort -u direct.domain -o direct.domain 2>/dev/null || touch direct.domain
          sort -u 1m-other.list -o 1m-other.list 2>/dev/null || touch 1m-other.list
          echo "ğŸ“„ direct.domain: $(wc -l < direct.domain) è¡Œ"
          echo "ğŸ“„ 1m-other.list (ç¬¬3æ¬¡å»é‡å): $(wc -l < 1m-other.list) è¡Œ"

      - name: Generate GFW IP CIDR list
        run: |
          curl -fsSL https://raw.githubusercontent.com/pmkol/easymosdns/rules/gfw_ip_list.txt -o gfw.ipcidr
          cat >> gfw.ipcidr <<'EOF'
          0.0.0.0/8
          10.0.0.0/8
          100.64.0.0/10
          127.0.0.0/8
          169.254.0.0/16
          172.16.0.0/12
          192.0.0.0/24
          192.0.2.0/24
          192.88.99.0/24
          192.168.0.0/16
          198.18.0.0/15
          198.51.100.0/24
          203.0.113.0/24
          224.0.0.0/4
          240.0.0.0/4
          EOF
          echo "ğŸ“„ gfw.ipcidr: $(wc -l < gfw.ipcidr) è¡Œ"

      - name: Cleanup temporary files
        run: |
          rm -f top-1m.csv.zip top-1m.csv top-1m.domain \
                reject-list.txt gfw-list.txt direct-list.txt \
                remaining-*.domain remaining-*.tmp *.tmp

      # å¼ºåˆ¶æ¨é€åˆ° release åˆ†æ”¯ï¼ˆä¸ä¿ç•™å†å²è®°å½•ï¼‰
      - name: Commit and force push
        shell: bash
        run: |
          set -euo pipefail

          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"

          git add .
          git commit -m "Update domain and IP lists" || echo "No changes to commit"
          git push --force origin release